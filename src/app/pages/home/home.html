<section class="container page">
  <header class="page__header">
    <img ngSrc="/assets/logos/nano-studio-logo.svg" width="300" height="50" alt="Nano Studio" priority />
    <p class="text-md text-muted flex flex-row page__header__description">
      Generate product visuals with
      <span class="flex flex-row"><img ngSrc="/assets/logos/gemini-logo.svg" width="100" height="20" alt="Gemini" /> <b>Nano Banana</b></span>
    </p>
    <p class="text-md text-muted page__header__description__sub">
      Upload, describe the vibe, and go.
    </p>
  </header>

  <div class="grid">
    <div class="card">
      <h2 class="text-xl fw-semibold">Your product</h2>
      <div class="upload" role="group" aria-labelledby="upload-label" aria-describedby="upload-help">
        <label id="upload-label" class="fw-semibold">Upload photo (JPG or PNG)</label>
        <input
          #fileInput
          type="file"
          class="input"
          accept="image/png,image/jpeg"
          (change)="onFileChange(fileInput.files)"
        />
        <p id="upload-help" class="text-sm text-muted">Best results with clear, well-lit product images.</p>

        @if (filePreviewUrl()) {
          <div class="preview">
            <img [src]="filePreviewUrl()!" alt="Uploaded product preview" />
          </div>
        }
      </div>

      <div class="section">
        <label for="prompt" class="fw-semibold">Describe the vibe</label>
        <textarea
          #promptArea
          id="prompt"
          class="input textarea"
          [value]="prompt()"
          (input)="onPromptInput(promptArea.value)"
          placeholder="e.g. Soft natural light, wooden tabletop, cozy morning scene"
          rows="4"
        ></textarea>
      </div>

      <div class="section">
        <div class="fw-semibold">Quick prompts</div>
        <div class="chips">
          @for (preset of presets(); track preset) {
            <button
              type="button"
              class="chip"
              [class.chip--active]="selectedPreset() === preset.title"
              (click)="onSelectPreset(preset)"
            >{{ preset.title }}</button>
          }
        </div>
      </div>

      <div class="actions flex items-center gap-3">
        <button
          type="button"
          class="btn btn-primary"
          [disabled]="!canGenerate()"
          [attr.aria-busy]="loading()"
          (click)="generate()"
        >
          @if (loading()) { Visualizing... } @else { Generate image }
        </button>
      </div>
    </div>

    <div class="card">
      <h2 class="text-xl fw-semibold">Result</h2>
      @if (loading()) {
        <div class="loading-section">
          <div class="loading-spinner" aria-hidden="true"></div>
          <p class="loading-message text-md">{{ loadingMessagesService.currentMessage() }}</p>
        </div>
      } @else if (hasResult()) {
        <div class="result">
          <img [src]="resultUrl()!" alt="Generated image result" />
        </div>
        <div class="section">
          <a
            class="btn btn-secondary"
            [href]="resultUrl()!"
            download="nano-generated.png"
            (click)="downloadResult($event)"
            rel="noopener"
          >Download</a>
        </div>
      } @else {
        <p class="text-sm text-muted">Your generated image will appear here.</p>
      }

      <div class="section">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg fw-semibold">Prompt history</h3>
          @if (history().length > 0) {
            <button type="button" class="btn btn-link text-sm" (click)="onClearHistory()">Clear all</button>
          }
        </div>

        @if (userPromptService.loading()) {
          <p class="text-sm text-muted">Loading history...</p>
        } @else if (userPromptService.error()) {
          <p class="text-sm text-danger">{{ userPromptService.error() }}</p>
        } @else if (history().length === 0) {
          <p class="text-sm text-muted">No history yet. Generate an image to see it here.</p>
        } @else {
          <ol class="history">
            @for (item of history(); track item.timestamp) {
              <li
                class="history__item"
                [class.history__item--active]="activeHistoryItem() === item"
                tabindex="0"
                role="button"
                [attr.aria-label]="'Select prompt: ' + (item.prompt | truncateText: 55)"
                (click)="onSelectHistoryItem(item)"
                (keydown.enter)="onSelectHistoryItem(item)"
                (keydown.space)="onSelectHistoryItem(item)"
              >
                <div class="history__text">{{ item.prompt | truncateText: 50 }}</div>
                <div class="history__meta">{{ item.timestamp | date: 'short' }}</div>
              </li>
            }
          </ol>
        }
      </div>
    </div>
  </div>
</section>
